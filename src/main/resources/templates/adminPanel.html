<!DOCTYPE html>
<html lang="en">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<!--    <link rel="stylesheet" href="../static/css/adminPage.css">-->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">


    <title>Admin panel</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* Set height of the grid so .sidenav can be 100% (adjust if needed) */
        .row.content {height: 1500px}

        /* Set gray background color and 100% height */
        .sidenav {
            background-color: #f1f1f1;
            height: 100%;
        }

        /* Set black background color, white text and some padding */
        footer {
            background-color: #555;
            color: white;
            padding: 15px;
        }

        /* On small screens, set height to 'auto' for sidenav and grid */
        @media screen and (max-width: 767px) {
            .sidenav {
                height: auto;
                padding: 15px;
            }
            .row.content {height: auto;}
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <label class="text-white col-md-11">
        <b th:text="${admin.userName}"></b> with roles: <span th:text="${roles}"></span>
    </label>
    <form class="form-inline">
        <button class="btn btn-sm align-middle btn-outline-secondary" onclick="window.location.href = '/logout'"
                value="Logout" type="button">Log out</button>
    </form>
</nav>

<header class="col-md-2">
    <nav class="sidebar-sticky navbar-expand-md">
        <div class="col-sm-2">
            <nav class="nav-sidebar">
                <ul class="nav tabs">
                    <li class="active"><a href="#adminPanel" data-toggle="tab">Admin</a></li>
                    <li class=""><a href="#userPanel" data-toggle="tab">User</a></li>
                </ul>
            </nav>
        </div>
    </nav>
</header>

<div class="col-sm-10 container-fluid">
    <div class="tab-content">
        <div class="tab-pane active text-style" id="adminPanel">
            <div id="sectionAdmin">
                <h2>Admin panel</h2>
                <p id="adminId" hidden th:text="*{admin.id}">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="active">
                        <a href="#usersTable" role="tab" data-toggle="tab"> Users table </a>
                    </li>
                    <li>
                        <a href="#newUserForm" role="tab" data-toggle="tab"> New user </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="usersTable">
                        <h2>All users</h2>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                <tr>
                                    <th>count</th>
                                    <th>ID</th>
                                    <th>userName</th>
                                    <th>name</th>
                                    <th>surname</th>
                                    <th>enabled</th>
                                    <th>age</th>
                                    <th>roles</th>
                                    <th>Edit</th>
                                    <th>Delete</th>
                                </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                </tbody>
                            </table>
                            <div class="modal hide" id="deleteModal">
                                <div class="modal-dialog modal-content">
                                    <form>
                                        <div class="modal-header">
                                            <h5 class="modal-title">Delete User</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeButtonInModalHeader">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="mx-auto modal-body text-center">
                                            <p>Id</p>
                                            <input type="number" class="form-control" id="deleteUserId" readonly/>

                                            <p>Name</p>
                                            <input type="text" class="form-control" id="deleteUserName" readonly/>

                                            <p>Surname</p>
                                            <input type="text" class="form-control" id="deleteUserSurname" readonly />

                                            <p>Age</p>
                                            <input type="number" class="form-control" id="deleteUserAge" readonly/>

                                            <p>Role</p>
                                            <select multiple class="form-control" id="deleteRolesSelector" name="role_id" required>
                                                <option value="ADMIN"> ADMIN </option>
                                                <option value="USER"> USER </option>
                                            </select>
                                        </div>

                                        <div class="modal-footer">
                                            <input type="button" class="btn btn-secondary closeButton" value="Close" data-dismiss="modal" id="closeButtonInModal">
                                            <input type="submit" class="btn btn-primary" value="Delete user" id="deleteButtonInModal">
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div class="modal hide" id="editModal">
                                <div class="modal-dialog modal-content">
                                    <form id="editUserForm">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Edit User</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeButtonInEditModalHeader">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="mx-auto modal-body text-center">
                                            <p>Id</p>
                                            <input type="number" class="form-control" id="editUserId" name="id" readonly/>

                                            <p>UserName</p>
                                            <input type="text" class="form-control" id="editUserName" name="userName"/>

                                            <p>Name</p>
                                            <input type="text" class="form-control" id="editName" name="name"/>

                                            <p>Surname</p>
                                            <input type="text" class="form-control" id="editUserSurname" name="surname"/>

                                            <p>Age</p>
                                            <input type="number" class="form-control" id="editUserAge" name="age"/>

                                            <p>Role</p>
                                            <select multiple class="form-control" id="editRolesSelector" name="role_id" required>
                                                <option value="ADMIN"> ADMIN </option>
                                                <option value="USER"> USER </option>
                                            </select>
                                        </div>

                                        <div class="modal-footer">
                                            <input type="button" class="btn btn-secondary closeButton" value="Close" data-dismiss="modal" id="closeButtonInEditModal">
                                            <input type="submit" class="btn btn-primary" value="Edit" id="editButtonInModal">
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div role="tabpanel" class="tab-pane" id="newUserForm">
                        <h2>Add new user</h2>
                        <form role="form" class="col-sm-3 " th:object="${userParams}">
                            <div>

                                <input type="hidden" th:field="*{id}">

                                <div class="form-group">
                                    <label for="inputUserName">UserName (login)</label>
                                    <input class="form-control" id="inputUserName" th:field="*{userName}">
                                </div>

                                <div class="form-group">
                                    <label for="inputPassword">Пароль</label>
                                    <input class="form-control" id="inputPassword" th:field="*{password}">
                                </div>

                                <div class="form-group">
                                    <label for="inputName">Name</label>
                                    <input class="form-control" id="inputName" th:field="*{name}">
                                </div>

                                <div class="form-group">
                                    <label for="inputSurname">Surname</label>
                                    <input class="form-control" id="inputSurname" th:field="*{surname}">
                                </div>

                                <div class="form-group">
                                    <label for="inputAge">Age</label>
                                    <input class="form-control" id="inputAge" th:field="*{age}">
                                </div>

                                <div class="form-group">
                                    <label for="inputRoles">Roles</label>
                                    <select class="form-select form-control" id="inputRoles" multiple th:name="rolesSet">
                                        <option value="1" th:value="ROLE_USER" >User</option>
                                        <option value="2" th:value="ROLE_ADMIN">Admin</option>
                                    </select>
                                </div>


                                <button id="adduserButton" class="btn btn-success" onclick="addUser(
                                    document.getElementById('inputUserName').value,
                                    document.getElementById('inputPassword').value,
                                    document.getElementById('inputName').value,
                                    document.getElementById('inputSurname').value,
                                    document.getElementById('inputAge').value,
                                    document.getElementById('inputRoles')
                                )">
                                    Save user!
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>
        <div class="tab-pane text-style" id="userPanel">
            <div id="sectionUser">

                <div>
                    <div class="container-fluid">
                        <h2>User information page</h2>
                        <div id="usersInfoPage">
                            <h2>About user</h2>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>userName</th>
                                        <th>name</th>
                                        <th>surname</th>
                                        <th>enabled</th>
                                        <th>age</th>
                                        <th>roles</th>
                                    </tr>
                                    </thead>
                                    <tbody id="adminInfoBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>



<script>
    var url = "http://localhost:8080/api/users";

    fetch(url)
        .then((response) => {
            return response.json();
        })
        .then((data) => {
            console.log(data);

            let temp = ""
            let index = 1

            data.forEach(user => {
                temp += '<tr>'
                temp += '<td>' + index++ + '</td>'
                temp += '<td>' + user.id + '</td>'
                temp += '<td>' + user.userName + '</td>'
                temp += '<td>' + user.name + '</td>'
                temp += '<td>' + user.surname + '</td>'
                temp += '<td>' + user.enabled + '</td>'
                temp += '<td>' + user.age + '</td>'

                let roles = ""
                for (let i = 0; i < user.roles.length; i++){
                    roles += user.roles[i].role.replace("ROLE_", "") + " "
                }

                temp += '<td>' + roles + '</td>'

                temp += '<td><button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteModal"' +
                    ' onclick="getUserForDeleteModal(' + user.id + ')" id="btnDelete">Delete</button></td>'

                temp += '<td><button type="button" class="btn btn-info" data-toggle="modal" data-target="#editModal"' +
                ' onclick="editUser(' + user.id + ')" id="btnEdit">Edit</button></td>'

                temp += "</tr>"

            })


            document.getElementById("usersTableBody").innerHTML = temp;
        });

    var urlAdmin = "http://localhost:8080/api/users/" + document.getElementById("adminId").textContent;

    fetch(urlAdmin)
        .then((response) => {
            return response.json();
        })
        .then((data) => {
            console.log(data);

            let temp = ''

            temp += "<tr>"
            temp += "<td>" + data.id + "</td>"
            temp += "<td>" + data.userName + "</td>"
            temp += "<td>" + data.name + "</td>"
            temp += "<td>" + data.surname + "</td>"
            temp += "<td>" + data.enabled + "</td>"
            temp += "<td>" + data.age + "</td>"

            let roles = ""
            for (let i = 0; i < data.roles.length; i++){
                roles += data.roles[i].role.replace("ROLE_", "") + " "
            }
            temp += "<td>" + roles + "</td>"

            temp += "</tr>"

            document.getElementById("adminInfoBody").innerHTML = temp;
        });


    function getUserForDeleteModal(id) {
        let closeButton = document.getElementById("closeButtonInModal");
        let deleteButton = document.getElementById("deleteButtonInModal");
        let modalDelete = document.getElementById("deleteModal");
        let closeButtonHeader = document.getElementById("closeButtonInModalHeader");

        fetch('http://localhost:8080/api/users/' + id)
            .then(response => response.json())
            .then((user) => {
                let roles = ""

                for (let i=0; i<user.roles.length; i++){
                    $("#deleteRolesSelector option[value='" + user.roles[i].role.replace("ROLE_", "") + "']").prop("selected", true);
                }


                $('#deleteUserName').val(user.name)
                $('#deleteUserSurname').val(user.surname)
                $('#deleteUserAge').val(user.age)
                $('#deleteUserId').val(user.id)
                $('#deleteUserRoles').val(roles)
            });

        deleteButton.onclick = function () {
            fetch('http://localhost:8080/api/users/' + id, {
                method: 'DELETE'
            });
        }

        closeButton.onclick = function () {
            modalDelete.style.display = "none";
        }

        closeButtonHeader.onclick = function () {
            modalDelete.style.display = "none";

        }

        window.onclick = function (event) {
            if (event.target == modalDelete) {
                modalDelete.style.display = "none";
            }
        }
    }

    function editUser(id) {
        let closeButton = document.getElementById("closeButtonInEditModal");
        let editButton = document.getElementById("editButtonInModal");
        let modalEdit = document.getElementById("editModal");
        let closeButtonHeader = document.getElementById("closeButtonInEditModalHeader");
        let editUserForm = document.forms['editUserForm']
        let options = document.getElementById('editRolesSelector').options;

        var arrayRoles = [];

        fetch('http://localhost:8080/api/users/' + id)
            .then(response => response.json())
            .then((user) => {
                for (let i=0; i<user.roles.length; i++){
                    $("#editRolesSelector option[value='" + user.roles[i].role.replace("ROLE_", "") + "']").prop("selected", true);
                }

                $('#editUserName').val(user.userName)
                $('#editName').val(user.name)
                $('#editUserSurname').val(user.surname)
                $('#editUserAge').val(user.age)
                $('#editUserId').val(user.id)
            });



        editButton.onclick = function () {
            fetch('http://localhost:8080/api/users/' + id)
                .then(response => response.json())
                .then((user) => {
                    for (let i=0; i<options.length; i++){
                        opt = options[i];
                        if (opt.selected) {
                            var roleObject = {'role' : "ROLE_" + opt.text.toUpperCase()};
                            arrayRoles.push(roleObject);
                        }
                    }

                    fetch('http://localhost:8080/api/users/' + id, {
                        method: 'PUT',
                        body: JSON.stringify({
                            userName: editUserForm.userName.value,
                            name: editUserForm.name.value,
                            surname: editUserForm.surname.value,
                            age: editUserForm.age.value,
                            password: user.password,
                            roles: arrayRoles
                        })
                    });
                });
        }

        closeButtonHeader.onclick = function () {
            modalEdit.style.display = "none";
        }

        closeButton.onclick = function () {
            modalEdit.style.display = "none";
        }
    }

</script>
<script>
     function addUser(userName, password, name, surname, age, roles){
        var url = "http://localhost:8080/api/users";

        var options = roles.options;
        var opt;
        var array = [];

        for (var i=0; i<options.length; i++) {

            opt = options[i];
            if (opt.selected) {
                var roleObject = {'role' : "ROLE_" + opt.text.toUpperCase()};
                array.push(roleObject);
                console.log(opt.text)
            }
        }

        const formData = new FormData();
        formData['userName'] = userName;
        formData['password'] = password;
        formData['name'] = name;
        formData['surname'] = surname;
        formData['age'] = age;
        formData['roles'] = array;

        const postMethod = {
            method: 'POST', // Method itself
            headers: {
                'Content-type': 'application/json; charset=UTF-8' // Indicates the content
            },
            body: JSON.stringify(formData) // We send data in JSON format
        }
        fetch(url, postMethod)
            .then(response => response.json())
            .then(data => console.log(data)) // Manipulate the data retrieved back, if we want to do something with it
            .catch(err => console.log(err))
    }
</script>

</body>
</html>




